<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãã„ã¦ ãˆã‚‰ã¶</title>

<style>
body{font-family:system-ui;text-align:center;background:#f5f5f5;margin:0;padding:20px}
button{font-size:18px;padding:10px 16px;margin:6px}
.choices{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;max-width:520px;margin:20px auto}
.choice{font-size:28px;padding:14px 0}
.top{display:flex;justify-content:space-between;max-width:520px;margin:auto}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);color:#fff;display:none;
align-items:center;justify-content:center;flex-direction:column}
</style>
</head>
<body>

<div id="start">
  <h2>ã‚‚ã˜ã‚’ ãˆã‚‰ã‚“ã§ã­</h2>
  <button onclick="setMode('hira')">ã²ã‚‰ãŒãª</button>
  <button onclick="setMode('kata')">ã‚«ã‚¿ã‚«ãƒŠ</button>

  <h2>ã˜ã‹ã‚“</h2>
  <button onclick="start(60)">1ã·ã‚“</button>
  <button onclick="start(120)">2ã·ã‚“</button>
  <button onclick="start(null)">ã˜ã‹ã‚“ãªã—</button>
</div>

<div id="game" style="display:none">
  <div class="top">
    <div>â± <span id="time">âˆ</span></div>
    <div>â­ <span id="score">0</span></div>
  </div>
  <button onclick="play()">ğŸ”Š ã‚‚ã†ã„ã¡ã©</button>
  <div class="choices" id="choices"></div>
</div>

<div id="overlay">
  <h2>ãŠã‚ã‚Š</h2>
  <p>ã‚¹ã‚³ã‚¢: <span id="final"></span></p>
  <button onclick="location.reload()">ã‚‚ã©ã‚‹</button>
</div>

<script>
/* ===== å…±é€šãƒ‡ãƒ¼ã‚¿ ===== */
const map = {
  a:["ã‚","ã‚¢"], i:["ã„","ã‚¤"], u:["ã†","ã‚¦"], e:["ãˆ","ã‚¨"], o:["ãŠ","ã‚ª"],
  ka:["ã‹","ã‚«"], ki:["ã","ã‚­"], ku:["ã","ã‚¯"], ke:["ã‘","ã‚±"], ko:["ã“","ã‚³"],
  sa:["ã•","ã‚µ"], shi:["ã—","ã‚·"], su:["ã™","ã‚¹"], se:["ã›","ã‚»"], so:["ã","ã‚½"],
  ta:["ãŸ","ã‚¿"], chi:["ã¡","ãƒ"], tsu:["ã¤","ãƒ„"], te:["ã¦","ãƒ†"], to:["ã¨","ãƒˆ"],
  na:["ãª","ãƒŠ"], ni:["ã«","ãƒ‹"], nu:["ã¬","ãƒŒ"], ne:["ã­","ãƒ"], no:["ã®","ãƒ"],
  ha:["ã¯","ãƒ"], hi:["ã²","ãƒ’"], fu:["ãµ","ãƒ•"], he:["ã¸","ãƒ˜"], ho:["ã»","ãƒ›"],
  ma:["ã¾","ãƒ"], mi:["ã¿","ãƒŸ"], mu:["ã‚€","ãƒ "], me:["ã‚","ãƒ¡"], mo:["ã‚‚","ãƒ¢"],
  ya:["ã‚„","ãƒ¤"], yu:["ã‚†","ãƒ¦"], yo:["ã‚ˆ","ãƒ¨"],
  ra:["ã‚‰","ãƒ©"], ri:["ã‚Š","ãƒª"], ru:["ã‚‹","ãƒ«"], re:["ã‚Œ","ãƒ¬"], ro:["ã‚","ãƒ­"],
  wa:["ã‚","ãƒ¯"], wo:["ã‚’","ãƒ²"], n:["ã‚“","ãƒ³"],
  ga:["ãŒ","ã‚¬"], gi:["ã","ã‚®"], gu:["ã","ã‚°"], ge:["ã’","ã‚²"], go:["ã”","ã‚´"],
  za:["ã–","ã‚¶"], ji:["ã˜","ã‚¸"], zu:["ãš","ã‚º"], ze:["ãœ","ã‚¼"], zo:["ã","ã‚¾"],
  da:["ã ","ãƒ€"], de:["ã§","ãƒ‡"], do:["ã©","ãƒ‰"],
  ba:["ã°","ãƒ"], bi:["ã³","ãƒ“"], bu:["ã¶","ãƒ–"], be:["ã¹","ãƒ™"], bo:["ã¼","ãƒœ"],
  pa:["ã±","ãƒ‘"], pi:["ã´","ãƒ”"], pu:["ã·","ãƒ—"], pe:["ãº","ãƒš"], po:["ã½","ãƒ"]
};

const sameSound = [
    ["o","wo"]
];

let mode="hira", list=[], answer="", score=0, time=null, timer=null, audio=null;

/* ===== ãƒ¢ãƒ¼ãƒ‰ ===== */
function setMode(m){
  mode=m;
  list=Object.entries(map).map(([r,k])=>({r, c:k[m==="hira"?0:1]}));
}

/* ===== é–‹å§‹ ===== */
function start(sec){
  document.getElementById("start").style.display="none";
  document.getElementById("game").style.display="block";
  score=0; time=sec;
  update();
  next(); play();

  if(sec){
    timer=setInterval(()=>{
      time--; update();
      if(time<=0) end();
    },1000);
  }
}

/* ===== å‡ºé¡Œ ===== */
function next(){
  answer=list[Math.floor(Math.random()*list.length)];
  const banned = sameSound
    .find(g => g.includes(answer.r)) || [];
  const candidates = list.filter(o => !banned.includes(o,r));
  const q=shuffle([...candidates]).slice(0,9);
  if(!q.includes(answer)) q[0]=answer;

  const c=document.getElementById("choices");
  c.innerHTML="";
  q.forEach(o=>{
    const b=document.createElement("button");
    b.className="choice";
    b.textContent=o.c;
    b.onclick=()=>check(o);
    c.appendChild(b);
  });
}

/* ===== åˆ¤å®š ===== */
function check(o){
  if(o===answer){
    score++; next(); play(); update();
  } else buzz();
}

/* ===== éŸ³ ===== */
function play(){
  if(audio) audio.pause();
  audio=new Audio(`sounds/${answer.r}.m4a`);
  audio.play();
}

function buzz(){
  const ctx=new AudioContext(), o=ctx.createOscillator(), g=ctx.createGain();
  o.frequency.value=120; g.gain.value=.1;
  o.connect(g); g.connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime+.15);
}

/* ===== UI ===== */
function update(){
  document.getElementById("score").textContent=score;
  document.getElementById("time").textContent=time??"âˆ";
}

function end(){
  clearInterval(timer);
  document.getElementById("final").textContent=score;
  document.getElementById("overlay").style.display="flex";
}

/* ===== util ===== */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
</script>
</body>
</html>
